# 試験対策アプリ 開発プロンプト（汎用テンプレート）

## ■ 基本情報（ここを書き換える）

```
アプリ名: [例: 狩猟マスター2026]
対象試験: [例: 狩猟免許試験]
免許/カテゴリ種別:
  - 種別1: [例: わな猟 (id: wana)]
  - 種別2: [例: 第一種銃猟 (id: type1)]
  - 種別3: [例: 第二種銃猟 (id: type2)]
出題カテゴリ: [例: 法令 / 猟具 / 生態]
applicationId: [例: com.huntingmaster.hunting_master_2026]
```

---

## ■ 技術スタック

| 項目 | 技術 |
|------|------|
| フレームワーク | Flutter (Material 3) |
| 状態管理 | Provider (ChangeNotifier) |
| ルーティング | go_router |
| データ永続化 | SharedPreferences |
| モデル生成 | freezed + json_serializable |
| 課金 | in_app_purchase |
| フォント | Google Fonts (Noto Sans JP) |
| 外部リンク | url_launcher |
| テスト | flutter_test |

---

## ■ アーキテクチャ

### ディレクトリ構成

```
lib/
├── main.dart                          # エントリーポイント（MultiProvider設定）
├── app.dart                           # MaterialApp.router
│
├── core/
│   ├── constants/
│   │   ├── app_constants.dart         # 問題数、合格基準、商品ID、ストレージキー
│   │   └── colors.dart                # カラーパレット定数
│   ├── router/
│   │   └── app_router.dart            # GoRouter全ルート定義
│   └── theme/
│       └── app_theme.dart             # Material 3テーマ
│
├── data/
│   ├── datasources/
│   │   ├── json_loader.dart           # assetsからJSON読み込み
│   │   └── local_storage_service.dart # SharedPreferencesシングルトン
│   ├── models/
│   │   ├── license_type.dart          # 免許種別enum
│   │   ├── question.dart              # @freezed 問題モデル
│   │   ├── [画像付きモデル].dart       # @freezed 画像問題用モデル（任意）
│   │   ├── user_progress.dart         # @freezed 学習進捗モデル
│   │   └── premium_status.dart        # プレミアム状態 + QuizMode enum
│   └── repositories/
│       ├── question_repository.dart   # 問題データ取得+キャッシュ
│       ├── [画像問題]_repository.dart  # 画像データ取得+キャッシュ（任意）
│       └── progress_repository.dart   # 進捗CRUD+計算
│
└── presentation/
    ├── providers/
    │   ├── quiz_provider.dart          # 択一クイズロジック
    │   ├── [画像]_quiz_provider.dart   # 画像クイズロジック（任意）
    │   ├── progress_provider.dart      # 進捗UI状態
    │   └── purchase_provider.dart      # 課金+プレミアム状態管理
    ├── screens/
    │   ├── splash/splash_screen.dart
    │   ├── home/home_screen.dart
    │   ├── menu/learning_menu_screen.dart
    │   ├── quiz/                       # 各クイズ画面
    │   ├── result/                     # 各結果画面
    │   ├── stats/stats_screen.dart
    │   ├── settings/settings_screen.dart
    │   └── purchase/purchase_screen.dart
    └── widgets/                        # 共通ウィジェット

assets/
├── data/
│   ├── questions_[種別1].json
│   ├── questions_[種別2].json
│   └── questions_[種別3].json
└── images/                             # 画像問題用（任意）

docs/
├── index.html                          # GitHub Pages トップ
├── privacy-policy.html                 # プライバシーポリシー
└── terms.html                          # 利用規約
```

---

## ■ データモデル設計

### 免許種別 (license_type.dart)

```dart
enum LicenseType {
  [種別1]('[表示名1]', '[id1]'),
  [種別2]('[表示名2]', '[id2]'),
  [種別3]('[表示名3]', '[id3]');
  const LicenseType(this.displayName, this.id);
  final String displayName;
  final String id;
  String get icon { /* 種別ごとの絵文字 */ }
}
```

### 問題モデル (question.dart - @freezed)

```dart
@freezed
class Question with _$Question {
  const factory Question({
    required String id,           // "[種別]_[カテゴリ]_001"
    required String category,     // 出題カテゴリ名
    required String question,     // 問題文
    required List<String> choices,// 選択肢（3択）
    required int correctAnswer,   // 正解インデックス (0-2)
    required String explanation,  // 解説
    String? reference,            // 法令参照等
    @Default(1) int difficulty,   // 難易度 1-3
    @Default([]) List<String> tags,
  }) = _Question;

  factory Question.fromJson(Map<String, dynamic> json) =>
      _$QuestionFromJson(json);
}
```

### 学習進捗モデル (user_progress.dart - @freezed)

```dart
@freezed
class UserProgress with _$UserProgress {
  const factory UserProgress({
    required String licenseType,
    @Default(0) int totalQuestions,
    @Default(0) int answeredQuestions,
    @Default(0) int correctAnswers,
    @Default(0.0) double accuracyRate,
    @Default(0) int totalStudyTimeMinutes,
    DateTime? lastStudiedAt,
    @Default(0) int consecutiveDays,
    @Default([]) List<String> weakCategories,
    @Default({}) Map<String, CategoryStats> categoryStats,
  }) = _UserProgress;
}

@freezed
class CategoryStats with _$CategoryStats {
  const factory CategoryStats({
    @Default(0) int totalQuestions,
    @Default(0) int correctAnswers,
    @Default(0.0) double accuracyRate,
  }) = _CategoryStats;
}
```

### プレミアム状態 (premium_status.dart)

```dart
enum QuizMode {
  // --- 無料モード ---
  multipleChoice('[択一問題名]', false),
  [無料モード2]('[表示名]', false),
  [無料モード3]('[表示名]', false),
  // --- プレミアムモード ---
  [有料モード1]('[表示名]', true),
  weakness('弱点克服モード', true),
  simulation('本番模擬試験', true);

  const QuizMode(this.displayName, this.isPremium);
  final String displayName;
  final bool isPremium;
}

enum PremiumPurchaseType {
  none, oneTime, monthly, yearly,
  // 旧バージョン移行用
  legacy1, legacy2, legacyBundle,
}

class PremiumStatus {
  final bool isPremium;
  final PremiumPurchaseType purchaseType;
  final DateTime? expiryDate;
  final bool isLegacyMigrated;

  bool get isActive {
    if (!isPremium) return false;
    if (purchaseType == PremiumPurchaseType.oneTime) return true;
    if (isLegacyMigrated) return true;
    if (expiryDate == null) return false;
    return expiryDate!.isAfter(DateTime.now());
  }

  bool canAccess(QuizMode mode) {
    if (!mode.isPremium) return true;
    return isActive;
  }

  // toJson / fromJson 実装
}
```

---

## ■ JSONデータフォーマット

### 問題データ (questions_[種別].json)

```json
{
  "license_type": "[種別id]",
  "version": "2026.1",
  "last_updated": "2026-02-10",
  "questions": [
    {
      "id": "[種別]_[カテゴリ略]_001",
      "category": "[カテゴリ名]",
      "question": "問題文をここに記載",
      "choices": ["選択肢A", "選択肢B", "選択肢C"],
      "correct_answer": 0,
      "explanation": "正解の解説",
      "reference": "根拠となる法令・参照元",
      "difficulty": 1,
      "tags": ["タグ1", "タグ2"]
    }
  ]
}
```

### 画像付き問題データ（任意: 画像判別系がある場合）

```json
{
  "version": "2026.1",
  "items": [
    {
      "id": "item_001",
      "name": "アイテム名",
      "name_en": "English Name",
      "type": "分類タイプ",
      "local_image": "assets/images/[カテゴリ]/[ファイル名].jpg",
      "images": ["https://ネットワークURL"],
      "image_attribution": "著作権表記",
      "description": "説明文",
      "identification_points": ["特徴1", "特徴2"]
    }
  ]
}
```

---

## ■ 画面構成とルーティング

### ルート一覧

| パス | 画面 | 用途 |
|------|------|------|
| `/` | SplashScreen | 起動画面（2秒） |
| `/home` | HomeScreen | ホーム（種別選択 + BottomNav） |
| `/stats` | StatsScreen | 学習統計 |
| `/settings` | SettingsScreen | 設定 |
| `/settings/licenses` | LicensesScreen | ライセンス表記 |
| `/purchase` | PurchaseScreen | プレミアム購入 |
| `/menu/:type` | LearningMenuScreen | クイズモード選択 |
| `/quiz/multiple/:type` | MultipleChoiceScreen | 択一クイズ（無料） |
| `/quiz/[モード名]/:type` | [モード名]Screen | 各クイズ画面 |
| `/quiz/simulation/:type` | SimulationScreen | 模擬試験（プレミアム） |
| `/result/:type` | ResultScreen | 結果表示 |
| `/result/simulation/:type` | SimulationResultScreen | 模擬試験結果 |

### 画面遷移フロー

```
Splash (2秒) → Home
Home → [種別カード選択] → LearningMenu
LearningMenu → [無料モード] → Quiz → Result → Home or リトライ
LearningMenu → [有料モード] → Premium判定
  → 未購入: PremiumDialogを表示 → Purchase画面
  → 購入済: Quiz → Result → Home or リトライ
BottomNav: Home / Stats / Settings (3タブ固定)
```

### BottomNavigationBar

```
[ホーム] [統計] [設定]
```
- 3タブ固定
- Home, Stats, Settings の3画面間を切り替え

---

## ■ フリーミアム設計

### 無料 / プレミアムの境界

| 機能 | 無料 | Premium |
|------|:---:|:---:|
| 択一問題（全種別） | ○ | ○ |
| [無料モード2]（全種別） | ○ | ○ |
| [無料モード3]（全種別） | ○ | ○ |
| [有料モード1] | × | ○ |
| 弱点克服モード | × | ○ |
| 本番模擬試験 | × | ○ |

### 課金プラン（3種）

| プラン | 商品ID | 価格例 |
|--------|--------|--------|
| 月額 | `[app_name]_monthly` | ¥480/月 |
| 年額 | `[app_name]_yearly` | ¥3,980/年 |
| 買い切り | `[app_name]_premium` | ¥1,980 |

### 広告
なし（フリーミアム課金のみで収益化）

### レガシーマイグレーション
旧バージョンで個別購入したユーザーは、自動的にプレミアムに昇格させる。
SharedPreferencesの旧キーを確認 → 新PremiumStatusに変換 → マイグレーション完了フラグを立てる。

---

## ■ 状態管理 (Provider)

### Provider一覧（main.dartで登録）

```dart
MultiProvider(
  providers: [
    ChangeNotifierProvider(create: (_) => QuizProvider()),
    ChangeNotifierProvider(create: (_) => [画像QuizProvider]()),   // 任意
    ChangeNotifierProvider(create: (_) => ProgressProvider()),
    ChangeNotifierProvider(create: (_) => PurchaseProvider()),
  ],
  child: const MyApp(),
)
```

### QuizProvider の主要メソッド

```dart
loadQuestions(licenseType)              // ランダム10問を読み込み
loadWeakQuestions(licenseType, categories)  // 弱点カテゴリから10問
loadSimulationQuestions(licenseType)    // ランダム50問（模擬試験）
answerQuestion(answerIndex)             // 回答を記録
nextQuestion() / previousQuestion()     // 問題移動
getResult() → QuizResult               // 正答率・合否判定
reset()                                 // 状態リセット
```

### PurchaseProvider の主要メソッド

```dart
initialize()                // IAP初期化 + プレミアム状態読込
purchase(ProductDetails)    // 購入処理
restorePurchases()          // 購入復元
canAccessQuizMode(QuizMode) // 機能アクセス判定
debugTogglePremium()        // デバッグ用切替（debugビルドのみ）
```

---

## ■ クイズフロー

### 択一クイズ

```
1. QuizProvider.loadQuestions(licenseType)
   → Repositoryから全問取得 → ランダムシャッフル → 先頭10問を選択
2. 画面表示: 問題文 + 3択 + 進捗バー + カテゴリチップ
3. ユーザーが選択肢タップ → answerQuestion(index)
4. 次の問題 → nextQuestion()
5. 最終問題回答後 → getResult()
6. 結果画面: 正答数/総数、正答率%、合否判定（70%基準）
7. カテゴリ別成績をプログレスバーで表示
8. ボタン: 「ホームへ」「もう一度挑戦」
```

### 模擬試験（プレミアム）

```
1. QuizProvider.loadSimulationQuestions(licenseType) → 50問
2. タイマー開始: 90分カウントダウン
3. 通常の択一と同じ回答フロー
4. タイマー切れ or 全問回答 → getResult()
5. 結果画面: 所要時間付き、カテゴリ別詳細、学習アドバイス
```

### 弱点克服（プレミアム）

```
1. ProgressProviderから弱点カテゴリ取得（正答率60%未満）
2. QuizProvider.loadWeakQuestions(licenseType, weakCategories)
3. 以降は択一クイズと同じフロー
```

---

## ■ 進捗トラッキング

### 保存タイミング
- 各クイズ終了時に `ProgressRepository.recordQuizResult()` を呼ぶ

### 計算ロジック

```
recordQuizResult(licenseType, totalQ, correctA, categoryResults, studyTime):
  1. 既存の進捗を読み込み
  2. カウンター加算: totalQuestions, answeredQuestions, correctAnswers
  3. accuracyRate = correctAnswers / answeredQuestions
  4. studyTimeMinutes += studyTime
  5. 連続日数: 同日→維持、翌日→+1、それ以外→リセット
  6. 弱点カテゴリ: 正答率60%未満のカテゴリを抽出
  7. SharedPreferencesに保存
```

### 統計画面の表示項目
- 全体: 総回答数、総正解数、全体正答率、総学習時間、最大連続日数
- 種別ごと: 進捗バー、正答率、最終学習日、連続日数
- 弱点カテゴリ一覧

---

## ■ テーマ・スタイリング

### カラーパレット

```dart
primary: Color(0xFF4CAF50)       // メインカラー（緑系推奨）
accent: Color(0xFFFF9800)        // アクセント（オレンジ）
success: Color(0xFF8BC34A)       // 正解・合格
warning: Color(0xFFFFC107)       // 注意・警告
error: Color(0xFFF44336)         // 不正解・不合格
info: Color(0xFF2196F3)          // 情報
background: Color(0xFFFAFAFA)    // 背景
textPrimary: Color(0xFF212121)   // 主要テキスト
textSecondary: Color(0xFF757575) // 補助テキスト
```

### 共通UIパターン
- 全画面 `SafeArea` でノッチ対応
- スクロールが必要な画面は `SingleChildScrollView` + `Column`
- padding: 16.0 標準
- Card: elevation 2, borderRadius 12
- Button: borderRadius 8
- AppBar: primary色, 白文字, elevation 0

---

## ■ 設定画面の構成

```
プレミアム
  - プレミアムプラン（有効/未購入の表示 → 購入画面へ）
  - [debugビルドのみ] デバッグ: プレミアム切り替えトグル

アプリ情報
  - バージョン

サポート
  - ヘルプ・よくある質問（ダイアログ表示）
  - アプリを評価する（Play Storeを開く）

法的情報
  - 利用規約（ダイアログ表示）
  - プライバシーポリシー（ダイアログ表示）
  - オープンソースライセンス（Flutter標準のshowLicensePage）
  - 画像ライセンス（専用画面、context.pushで遷移）
```

---

## ■ リリース設定

### Android署名

```
android/
├── key.properties           # ← .gitignoreに追加（コミットしない）
├── upload-keystore.jks      # ← .gitignoreに追加（コミットしない）
└── app/build.gradle.kts     # keystoreProperties読み込み + signingConfigs
```

### .gitignore に追加必須

```
android/key.properties
android/upload-keystore.jks
*.jks
*.keystore
```

### ビルドコマンド

```bash
flutter build appbundle --release
# 出力: build/app/outputs/bundle/release/app-release.aab
```

### GitHub Pages（プライバシーポリシー・利用規約）

```
docs/
├── index.html              # ランディングページ
├── privacy-policy.html     # プライバシーポリシー
└── terms.html              # 利用規約
```
GitHub Settings → Pages → Branch: master, Folder: /docs

---

## ■ Google Play Console テストリリース手順

1. アプリを作成（アプリ名、言語: 日本語、無料、宣言チェック）
2. ストア掲載情報を入力（アプリ名、説明、スクリーンショット、アイコン）
3. コンテンツレーティング回答
4. プライバシーポリシーURL設定（GitHub Pages）
5. 内部テスト → 新しいリリース作成 → .aab アップロード
6. テスター追加（メーリングリスト）→ テストリンク配布
7. 収益化設定（販売アカウント設定後）:
   - アプリ内アイテム: 買い切り商品
   - 定期購入: 月額・年額
8. 製品版リリース（Google審査 1〜7日）

---

## ■ 新しいアプリに転用する手順

### 1. 書き換える部分

| 項目 | ファイル |
|------|---------|
| アプリ名・applicationId | `pubspec.yaml`, `AndroidManifest.xml`, `build.gradle.kts` |
| 免許種別 enum | `license_type.dart` |
| クイズモード enum | `premium_status.dart` |
| 商品ID・ストレージキー | `app_constants.dart` |
| 問題データJSON | `assets/data/questions_*.json` |
| 画像データ（任意） | `assets/images/`, `animals.json` 相当 |
| カラーパレット | `colors.dart` |
| アプリ名表示 | `app.dart`, `home_screen.dart`, `splash_screen.dart` |
| ストア評価URL | `settings_screen.dart` |
| docs/ の内容 | `privacy-policy.html`, `terms.html` |

### 2. そのまま流用できる部分

| 項目 | ファイル |
|------|---------|
| Provider基盤 | `quiz_provider.dart`, `progress_provider.dart`, `purchase_provider.dart` |
| ルーター構造 | `app_router.dart` |
| 進捗トラッキング | `progress_repository.dart`, `user_progress.dart` |
| フリーミアム基盤 | `premium_status.dart`, `purchase_screen.dart` |
| SharedPreferences | `local_storage_service.dart` |
| テーマ構造 | `app_theme.dart` |
| 設定画面 | `settings_screen.dart`（FAQ内容のみ変更） |
| 結果画面 | `result_screen.dart`, `simulation_result_screen.dart` |
| GitHub Pages構造 | `docs/` テンプレート |
| 署名設定 | `build.gradle.kts` の構造 |

### 3. 問題データだけ差し替えれば動く最小構成

1. `license_type.dart` の enum を変更
2. `app_constants.dart` の商品ID・キーを変更
3. `assets/data/questions_*.json` を新試験の問題に差し替え
4. アプリ名・色を変更
5. ビルド → リリース
